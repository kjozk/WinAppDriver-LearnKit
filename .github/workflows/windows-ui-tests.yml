name: Windows UI テスト

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  ui-tests:
    name: ビルド・UI テスト (Windows)
    runs-on: windows-latest
    timeout-minutes: 60
    steps:
      - name: チェックアウト
        uses: actions/checkout@v4

      - name: NuGet パッケージ復元（安全）
        shell: powershell
        run: |
          $sln = Get-ChildItem -Path . -Recurse -Filter *.sln | Select-Object -First 1
          if ($sln) {
            Write-Host "Found solution: $($sln.FullName) -- running nuget restore"
            nuget restore $sln.FullName
          } else {
            Write-Host "No .sln file found. Skipping nuget restore."
          }

      - name: ソリューション ビルド
        shell: powershell
        run: |
            # Visual Studio インストールパスを取得
            $vsPath = & "C:\Program Files (x86)\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -requires Microsoft.Component.MSBuild -property installationPath

            # MSBuild.exe のパス
            $msbuildPath = Join-Path $vsPath "MSBuild\Current\Bin\MSBuild.exe"

            # ビルド実行
            & $msbuildPath "WinAppDriver-LearnKit.sln" /p:Configuration=Debug /m

      - name: WinAppDriver インストール
        shell: powershell
        run: choco install winappdriver -y

      - name: WinAppDriver 起動
        shell: powershell
        run: |
            $exe = 'C:\Program Files (x86)\Windows Application Driver\WinAppDriver.exe'
            if (-not (Test-Path $exe)) { Write-Host "WinAppDriver not found at $exe"; exit 1 }
            Start-Process -FilePath $exe -ArgumentList '4723'
            Start-Sleep -Seconds 5

      - name: テスト実行（vstest 検索・trx ロガー）
        shell: powershell
        run: |
            # テストアセンブリを探す
            $dll = Get-ChildItem -Path tests -Recurse -Filter *SampleApp.Tests.UI.dll | Select-Object -First 1
            if (-not $dll) { Write-Error 'Test assembly not found'; exit 1 }

            # vstest.console.exe を vswhere で取得
            $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
            if (-not (Test-Path $vswhere)) { Write-Error 'vswhere.exe not found'; exit 1 }

            $vsPath = & $vswhere -latest -products * -requires Microsoft.VisualStudio.Component.TestTools.TestPlatform -property installationPath
            if (-not $vsPath) { Write-Error 'Visual Studio installation not found'; exit 1 }

            $vstestCmd = Join-Path $vsPath "Common7\IDE\CommonExtensions\Microsoft\TestWindow\vstest.console.exe"
            if (-not (Test-Path $vstestCmd)) { Write-Error 'vstest.console.exe not found'; exit 1 }

            # テスト実行
            & $vstestCmd $dll.FullName /Logger:trx

      - name: TRX テスト結果をアップロード
        uses: actions/upload-artifact@v4
        with:
          name: trx-results
          path: '**/*.trx'

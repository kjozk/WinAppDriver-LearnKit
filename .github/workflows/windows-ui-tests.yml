name: Windows UI Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  ui-tests:
    name: Build and UI Tests (Windows)
    runs-on: windows-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore NuGet packages
        run: nuget restore "WinAppDriver-LearnKit.sln"
        shell: powershell

      - name: Build solution
        run: msbuild "WinAppDriver-LearnKit.slnx" /p:Configuration=Debug /m
        shell: powershell

      - name: Install WinAppDriver
        run: choco install winappdriver -y
        shell: powershell

      - name: Start WinAppDriver
        run: |
          $exe = 'C:\Program Files (x86)\Windows Application Driver\WinAppDriver.exe'
          if (-not (Test-Path $exe)) { Write-Host "WinAppDriver not found at $exe"; exit 1 }
          Start-Process -FilePath $exe -ArgumentList '4723'
          Start-Sleep -Seconds 5
        shell: powershell

      - name: Run tests (find vstest and run trx logger)
        run: |
          $dll = Get-ChildItem -Path tests -Recurse -Filter *SampleApp.Tests.UI.dll | Select-Object -First 1
          if (-not $dll) { Write-Error 'Test assembly not found'; exit 1 }

          $vstestCmd = (Get-Command vstest.console.exe -ErrorAction SilentlyContinue).Source
          if (-not $vstestCmd) {
            $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
            if (Test-Path $vswhere) {
              $vsPath = & $vswhere -latest -products * -requires Microsoft.VisualStudio.Component.TestTools.TestPlatform -property installationPath
              if ($vsPath) {
                $candidate = Join-Path $vsPath "Common7\IDE\CommonExtensions\Microsoft\TestWindow\vstest.console.exe"
                if (Test-Path $candidate) { $vstestCmd = $candidate }
              }
            }
          }

          if (-not $vstestCmd) { Write-Error 'vstest.console.exe not found on PATH or in Visual Studio installation'; exit 1 }

          & $vstestCmd $dll.FullName /Logger:trx
        shell: powershell

      - name: Upload TRX test results
        uses: actions/upload-artifact@v4
        with:
          name: trx-results
          path: '**/*.trx'

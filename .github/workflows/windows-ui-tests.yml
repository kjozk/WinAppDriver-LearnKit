name: Windows UI テスト

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  ui-tests:
    name: ビルド・UI テスト (Windows)
    runs-on: windows-latest
    timeout-minutes: 60
    steps:
      - name: チェックアウト
        uses: actions/checkout@v4

      - name: NuGet パッケージ復元（安全）
        shell: powershell
        run: |
          $sln = Get-ChildItem -Path . -Recurse -Filter *.sln | Select-Object -First 1
          if ($sln) {
            Write-Host "Found solution: $($sln.FullName) -- running nuget restore"
            nuget restore $sln.FullName
          } else {
            Write-Host "No .sln file found. Skipping nuget restore."
          }

      - name: ソリューション ビルド
        shell: powershell
        run: |
            # Visual Studio インストールパスを取得
            $vsPath = & "C:\Program Files (x86)\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -requires Microsoft.Component.MSBuild -property installationPath

            # MSBuild.exe のパス
            $msbuildPath = Join-Path $vsPath "MSBuild\Current\Bin\MSBuild.exe"

            # ビルド実行
            & $msbuildPath "WinAppDriver-LearnKit.sln" /p:Configuration=Debug /m

      - name: WinAppDriver インストール
        shell: powershell
        run: choco install winappdriver -y

      - name: WinAppDriver 起動
        shell: powershell
        run: |
            $exe = 'C:\Program Files (x86)\Windows Application Driver\WinAppDriver.exe'
            if (-not (Test-Path $exe)) { Write-Host "WinAppDriver not found at $exe"; exit 1 }
            Start-Process -FilePath $exe -ArgumentList '4723'
            Start-Sleep -Seconds 5

      - name: テスト実行（DLL 相対パス指定）
        shell: powershell
        run: |
            # まず既知の相対パスを優先して探す
            $dllPath = Join-Path $PWD "tests\SampleApp.Tests.UI\bin\Debug\SampleApp.Tests.UI.dll"
            if (-not (Test-Path $dllPath)) {
              Write-Host "DLL not found at $dllPath. Searching under tests..."
              $dll = Get-ChildItem -Path tests -Recurse -Filter *SampleApp.Tests.UI.dll | Select-Object -First 1
              if (-not $dll) { Write-Error 'Test assembly not found'; exit 1 } else { $dllPath = $dll.FullName }
            } else { Write-Host "Found test dll: $dllPath" }

            # vstest.console.exe が PATH にあればそれを使う。なければ dotnet vstest を試す。
            $vstest = Get-Command vstest.console.exe -ErrorAction SilentlyContinue
            if ($vstest) {
              Write-Host "Running tests with vstest.console.exe"
              & $vstest.Source $dllPath /Logger:trx
            } elseif (Get-Command dotnet -ErrorAction SilentlyContinue) {
              Write-Host "vstest not found; falling back to 'dotnet vstest'"
              dotnet vstest $dllPath --logger trx
            } else {
              Write-Error "Neither vstest.console.exe nor dotnet were found. Cannot run tests."
              exit 1
            }

      - name: TRX テスト結果をアップロード
        uses: actions/upload-artifact@v4
        with:
          name: trx-results
          path: '**/*.trx'
